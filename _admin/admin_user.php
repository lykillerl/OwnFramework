<?php#Create by LYK on 2009-12-12 @ 17:40PMdefine('DIR_LEVEL', 1);include_once ("../_init.php");$DPass = md5('1234');$License['User'] = (strtolower($License['User']) === 'x-limit' ? -(int)1 : (int)$License['User']);$Enum_Boolean = array("Y" => Lang("Yes"), "N" => Lang("No"));function Valid_User(){    global $__SysUser;    $iCount = 0;    foreach ($__SysUser as $Key => $User)        if ($User['ACCESS'] === true)            $iCount++;    return $iCount;}switch ($Action){    case "RegUser":        $Title = Lang("Register/Edit User");        $UName = strtolower($UName);        $Profile = ($Profile === 'N' ? false : true);        $User_Exists = false;        foreach ($__SysUser as $Key => $User)            if ($ID !== $Key && $User['UNAME'] === $UName)                $User_Exists = true;        if (empty($FName) || empty($UName) || empty($Email) || empty($ULang))            $Sys->Json_Respone("respone", $Sys->Unknow(Lang("Please fill in the blank, thank you.")),                array("Title" => $Title));        elseif (preg_match("/'[0-9A-Za-z\-_]/", $RUName))            $Sys->Json_Respone("respone", $Sys->Warning(Lang("Sorry, username can only contain 'a-z','A-Z','0-9','-','_'")),                array("Title" => $Title));        elseif ($User_Exists)            $Sys->Json_Respone("respone", $Sys->Warning(Lang("Sorry, username already in use.")),                array("Title" => $Title));        elseif ($License['User'] >= 0 && Valid_User() >= $License['User'] && !empty($ID))            $Sys->Json_Respone("error", $Sys->Warning(Lang("Your was reatch your license limit, you only able have ") .                " {$License['User']} " . Lang(" valid user.")), array("Title" => $Title));        else        {            $Title = Lang("User Register");            $UI = "Msg_Users";            if (!is_array($__SysUser))                $__SysUser = array(array("ADMIN" => true));            if (!empty($ID))            {                $__SysUser[$ID]['UNAME'] = $UName;                $__SysUser[$ID]['FNAME'] = $FName;                $__SysUser[$ID]['EMAIL'] = $Email;                $__SysUser[$ID]['PROFILE'] = $Profile;                $__SysUser[$ID]['LANG'] = $ULang;            }            else            {                $__SysUser[] = array(                    'FNAME' => $FName,                    'UNAME' => $UName,                    'EMAIL' => $Email,                    'ADMIN' => false,                    'UPWD' => $DPass,                    'LANG' => $ULang,                    'PROFILE' => $Profile,                    'ACCESS' => true,                    'FBID' => 0);            }            if (!Data_To_File("{DATA_SYSUSER}", $__SysUser))            {                if (!empty($ID))                    $Sys->Json_Respone("error", $Sys->Warning(Lang("Sorry, currently unable update user profile.")),                        array("Title" => $Title));                else                    $Sys->Json_Respone("ok", $Sys->Warning(Lang("Sorry, currently unable register new user.")),                        array("Title" => $Title));            }            else            {                if (!empty($ID))                    $Sys->Json_Respone("ok", $Sys->Success(Lang("Successful, update user profile.")),                        array("Title" => $Title, "Reload" => true));                else                    $Sys->Json_Respone("ok", $Sys->Success(Lang("Successful, register a new user profile.")),                        array("Title" => $Title, "Reload" => true));            }        }        break;    case "Access":        $Title = Lang("Update User Access");        if (empty($ID) || empty($Enable))            $Sys->Json_Respone("error", $Sys->Warning(Lang("Sorry, unknow user id and status.")),                array("Title" => $Title));        elseif ($License['User'] >= 0 && Valid_User() > $License['User'])            $Sys->Json_Respone("error", $Sys->Warning(Lang("Your was reatch your license limit, you only able have ") .                " {$License['User']} " . Lang(" valid user.")), array("Title" => $Title));        else        {            $Enable = ($Enable === 'Y') ? true : false;            if (array_key_exists($ID, $__SysUser))                $__SysUser[$ID]['ACCESS'] = $Enable;            if (!Data_To_File("{DATA_SYSUSER}", $__SysUser))                $Sys->Json_Respone("error", $Sys->Warning(Lang("Sorry, unable update the user profile.")),                    array("Title" => $Title));            else                $Sys->Json_Respone("ok", $Sys->Success(Lang("Successful updated the user access.")),                    array("Title" => $Title));        }        break;    case "SelUser":        if (!empty($ID))        {            $UName = $__SysUser[$ID]['UNAME'];            $FName = $__SysUser[$ID]['FNAME'];            $Email = $__SysUser[$ID]['EMAIL'];            $Profile = $__SysUser[$ID]['PROFILE'];            $ULang = $__SysUser[$ID]['LANG'];            $Profile = ($Profile === true) ? "Y" : "N";        }        break;    case "Reset";        if (!empty($ID))        {            $Title = Lang("Reset Password");            if (array_key_exists($ID, $__SysUser))                $__SysUser[$ID]['UPASS'] = $DPass;            if (!Data_To_File("{DATA_SYSUSER}", $__SysUser))                $Sys->Json_Respone("error", $Sys->Success(Lang("Sorry, currently unable update user profile.")),                    array("Title" => $Title));            else                $Sys->Json_Respone("ok", $Sys->Success(Lang("User password was reset to 1234")),                    array("Title" => $Title));        }        break;}switch ($UI){    case "Confirm_Access":        $Sys->WebPut($Sys->Js_AskBox(Lang("This user account will be ") . (($Enable == "N") ? $Sys->            Warning(Lang("disable")) : $Sys->Success(Lang("enable"))) . Lang(", are you sure?"), $Sys->            ActRequest(Lang("Confirm"), "{SPG_USER}", array(            'Action' => 'Access',            'ID' => $ID,            'Access' => (($Enable == "N") ? "N" : "Y"))), $Sys->Normal(Lang("System User Access"))));        break;    case "Confirm_Reset":        $Sys->WebPut($Sys->Js_AskBox(Lang("This action will reset the user password to default setting, are you sure"),            $Sys->ActRequest_Button(Lang("Confirm"), "{SPG_USER}", array('Action' => 'Reset', 'ID' => $ID)),            $Sys->Normal(Lang("Reset Password"))));        break;    case "RegUser":        $Status = (!empty($Status) ? $Status : $Sys->Normal(Lang("System User Registration")));        $SMode = (!empty($ID) ? $Sys->Inform($Sys->Strong(Lang("Edit Mode"))) : $Sys->Success(Lang("Add Mode")));        $Sys->WebPut($Sys->Box($Sys->Build_Form(Lang("Registration Form"), array(            Lang("Mode") => $SMode,            Lang("Full Name") => $Sys->Text("FName", $FName, 'off') . $Sys->Warning("*") . $Sys->                Span("V_FName"),            Lang("Username") => $Sys->Text("UName", $UName, 'off') . $Sys->Warning("*") . $Sys->                Span("V_UName"),            Lang("Email") => $Sys->Text("Email", $Email, 'off') . $Sys->Warning("*") . $Sys->Span("V_Email"),            Lang("Profile Access") => $Sys->SelStr("Profile", $Enum_Boolean, ($Profile !== 'N') ? 'Y' : 'N'),            Lang("Language") => $Sys->SelStr("ULang", $Lang_Bag, $ULang),            Lang("Status") => $Sys->Span('Status', $Status)), array($Sys->ActRequest_Button(Lang("Submit"),                "{SPG_USER}", array(                'Action' => $UI,                'ID' => $ID,                'UI' => $UI), "#Users_Form", "#Status", null, "btn_reguser")), 1, 'Users_Form',            '40em'), Lang("Register/Edit System User")));        $Sys->WebJs($Sys->Js_ObjFocus('#FName') . $Sys->Js_BindKey('enter', "function(){_$('#btn_reguser').Click();}") .            $Sys->Js_Validate("#FName", array("Method" => "must", "Feedback" => array("#V_FName" =>                    $Sys->Warning("Please fill the full name.")))) . $Sys->Js_Validate("#UName",            array(            "Method" => "must",            "Min" => 6,            "Feedback" => array("#V_UName" => $Sys->Warning("Please fill at least 6 characters.")))) .            $Sys->Js_Validate("#Email", array("Method" => "email", "Feedback" => array("#V_Email" =>                    $Sys->Warning("Please fill in valid email.")))));        break;    default:        $Pg_Count = 10;        $TCount = count($__SysUser);        $iPos = (int)0;        $TData = array();        $THCol = array(            Lang("No."),            Lang("Full name"),            Lang("Username"),            Lang("Email"),            Lang("Profile"),            Lang("Link to Facebook"),            Lang("Enable"),            Lang("Reset Password"),            $Sys->Normal(Lang("Edit"), 1));        foreach ($__SysUser as $_ID => $MD)        {            if ($MD['ADMIN'] === false)            {                $iPos++;                $TData[] = array(                    $iPos,                    IfEmptyH($MD['FNAME']),                    IfEmptyH($MD['UNAME']),                    IfEmptyH($MD['EMAIL']),                    ($MD['PROFILE'] === true) ? $Sys->Success(Lang("Access able"), 1) : $Sys->                        Warning(Lang("Profile Locked"), 1),                    (!empty($MD['FBID']) ? $Sys->Success(Lang("Linked to Facebook")) : $Sys->Unknow                        (Lang("No link to facebook"))),                    ($MD['ACCESS'] === true) ? $Sys->Success(Lang("Enable"), 1) : $Sys->Warning(Lang                        ("Disable"), 1) . "(" . $Sys->Ajax_Link_Fancy(Lang("Set"), "{SPG_USER}",                        array(                        'UI' => 'Confirm_Access',                        'ID' => $_ID,                        'Access' => (($MD['ACCESS'] === false) ? "Y" : "N"))) . ")",                    (($MD['UPASS'] === $DPass) ? $Sys->Ajax_Link_Execute($Sys->Inform(Lang("Reset Password"),                        1), "{SPG_USER}", array('ID' => $_ID, 'UI' => 'Confirm_Reset')) : $Sys->                        Unknow(Lang("Is Default"))),                    $Sys->Ajax_Link_Fancy($Sys->Normal(Lang("Edit"), 1), "{SPG_USER}", array(                        'Action' => 'SelUser',                        'ID' => $_ID,                        'UI' => 'RegUser')));            }        }        $Sys->WebPut($Sys->TBTab($Sys->TBGrid($TData, Lang("System User List"), $THCol,            "System_User_Lister", Lang("No any system user."), null, true), null, $Sys->            Ajax_Button_Fancy(Lang("Register New User"), "{SPG_USER}", array('UI' => 'RegUser')),            Lang("System User Management")));        $Sys->WebPut($Sys->Pagination($Pg_Count, $TCount, $Pg_Now, "{SPG_USER}", null));}$Sys->WebOut(true);?>